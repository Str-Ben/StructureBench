// 简化的 SQL 语法 CFG
// 支持常用的 SQL 语句：SELECT, INSERT, UPDATE, DELETE, CREATE TABLE, DROP TABLE

// ============== 入口规则 ==============
start: sql_statement

sql_statement: select_stmt
             | insert_stmt
             | update_stmt
             | delete_stmt
             | create_table_stmt
             | drop_table_stmt
             | alter_table_stmt

// ============== SELECT 语句 ==============
select_stmt: "SELECT" select_list "FROM" table_references [where_clause] [group_by_clause] [having_clause] [order_by_clause] [limit_clause]

select_list: "*"
           | select_item ("," select_item)*

select_item: expr [["AS"] column_alias]

table_references: table_reference ("," table_reference)*

table_reference: table_name [["AS"] table_alias]
               | "(" select_stmt ")" ["AS"] table_alias
               | table_name join_clause

join_clause: join_type "JOIN" table_name [["AS"] table_alias] "ON" condition
join_type: ["INNER"] | "LEFT" ["OUTER"] | "RIGHT" ["OUTER"] | "FULL" ["OUTER"] | "CROSS"

where_clause: "WHERE" condition

group_by_clause: "GROUP" "BY" expr ("," expr)*

having_clause: "HAVING" condition

order_by_clause: "ORDER" "BY" order_item ("," order_item)*
order_item: expr ["ASC" | "DESC"]

limit_clause: "LIMIT" integer ["OFFSET" integer]

// ============== INSERT 语句 ==============
insert_stmt: "INSERT" "INTO" table_name ["(" column_list ")"] insert_values

insert_values: "VALUES" value_list ("," value_list)*
             | select_stmt

column_list: column_name ("," column_name)*

value_list: "(" expr ("," expr)* ")"

// ============== UPDATE 语句 ==============
update_stmt: "UPDATE" table_name "SET" assignment_list [where_clause]

assignment_list: assignment ("," assignment)*
assignment: column_name "=" expr

// ============== DELETE 语句 ==============
delete_stmt: "DELETE" "FROM" table_name [where_clause]

// ============== CREATE TABLE 语句 ==============
create_table_stmt: "CREATE" "TABLE" [if_not_exists] table_name "(" column_def_list [table_constraints] ")"

if_not_exists: "IF" "NOT" "EXISTS"

column_def_list: column_def ("," column_def)*

column_def: column_name data_type [column_constraints]

data_type: "INT" | "INTEGER"
         | "BIGINT"
         | "SMALLINT"
         | "TINYINT"
         | "FLOAT"
         | "DOUBLE"
         | "DECIMAL" ["(" integer ["," integer] ")"]
         | "NUMERIC" ["(" integer ["," integer] ")"]
         | "CHAR" ["(" integer ")"]
         | "VARCHAR" "(" integer ")"
         | "TEXT"
         | "DATE"
         | "TIME"
         | "DATETIME"
         | "TIMESTAMP"
         | "BOOLEAN"
         | "BOOL"
         | "JSON"

column_constraints: column_constraint+

column_constraint: "NOT" "NULL"
                 | "NULL"
                 | "PRIMARY" "KEY"
                 | "UNIQUE"
                 | "AUTO_INCREMENT"
                 | "DEFAULT" literal
                 | "CHECK" "(" condition ")"
                 | foreign_key_constraint

foreign_key_constraint: "REFERENCES" table_name "(" column_name ")"

table_constraints: "," table_constraint ("," table_constraint)*

table_constraint: "PRIMARY" "KEY" "(" column_list ")"
                | "UNIQUE" "(" column_list ")"
                | "FOREIGN" "KEY" "(" column_list ")" "REFERENCES" table_name "(" column_list ")"
                | "CHECK" "(" condition ")"

// ============== DROP TABLE 语句 ==============
drop_table_stmt: "DROP" "TABLE" [if_exists] table_name

if_exists: "IF" "EXISTS"

// ============== ALTER TABLE 语句 ==============
alter_table_stmt: "ALTER" "TABLE" table_name alter_action

alter_action: "ADD" "COLUMN" column_def
            | "DROP" "COLUMN" column_name
            | "MODIFY" "COLUMN" column_def
            | "RENAME" "TO" table_name

// ============== 表达式和条件 ==============
condition: or_condition

or_condition: and_condition ("OR" and_condition)*

and_condition: not_condition ("AND" not_condition)*

not_condition: ["NOT"] comparison

comparison: expr comparison_op expr
          | expr "BETWEEN" expr "AND" expr
          | expr ["NOT"] "IN" "(" (expr ("," expr)* | select_stmt) ")"
          | expr "IS" ["NOT"] "NULL"
          | expr ["NOT"] "LIKE" string_literal
          | "EXISTS" "(" select_stmt ")"
          | "(" condition ")"

comparison_op: "=" | "!=" | "<>" | "<" | "<=" | ">" | ">="

expr: term (("+"|"-") term)*

term: factor (("*"|"/"|"%") factor)*

factor: ["+"|"-"] primary

primary: literal
       | column_ref
       | function_call
       | "(" expr ")"
       | "(" select_stmt ")"
       | case_expr
       | aggregate_function

column_ref: [table_name "."] column_name

function_call: function_name "(" [expr ("," expr)*] ")"

aggregate_function: aggregate_name "(" ["DISTINCT"] (expr | "*") ")"

aggregate_name: "COUNT" | "SUM" | "AVG" | "MIN" | "MAX"

case_expr: "CASE" [expr] when_clause+ ["ELSE" expr] "END"

when_clause: "WHEN" condition "THEN" expr

// ============== 字面量 ==============
literal: integer
       | float_number
       | string_literal
       | boolean_literal
       | "NULL"

integer: /[0-9]+/

float_number: /[0-9]+\.[0-9]+/

string_literal: /'([^'\\]|\\.)*'/
              | /"([^"\\]|\\.)*"/

boolean_literal: "TRUE" | "FALSE"

// ============== 标识符 ==============
table_name: identifier
column_name: identifier
column_alias: identifier
table_alias: identifier
function_name: identifier

identifier: /[a-zA-Z_][a-zA-Z0-9_]*/
          | /`[^`]+`/
          | /"[^"]+"/
          | /\[[^\]]+\]/

// ============== 空白符处理 ==============
%import common.WS
%ignore WS

// ============== 注释 ==============
COMMENT: /--[^\n]*/
       | /\/\*(.|\n)*?\*\//

%ignore COMMENT

