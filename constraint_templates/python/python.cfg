start: file

# 顶层：可选若干 import + 一个函数
# file: NEWLINE* (import_stmt NEWLINE)* funcdef NEWLINE*
file: funcdef NEWLINE*


import_stmt: "import" WS dotted_name
          | "from" WS dotted_name WS "import" WS import_targets

import_targets: NAME (COMMA WS? NAME)*
              | "*"

dotted_name: NAME (DOT NAME)*

# ---------------- function ----------------

funcdef: "def" WS NAME LPAREN param_list? RPAREN (WS ARROW WS type_name)? COLON block1

param_list: NAME (COMMA WS? NAME)*

# ---------------- indentation (分层缩进，最多 10 层) ----------------
# 约束策略：每一层 blockN 只允许以 INDENTN 开头的行。
# if/for/while 的 body 进入下一层 block(N+1)。

block1: NEWLINE block1_line+
block1_line: INDENT1 simple_stmt NEWLINE | INDENT1 if_stmt1 | INDENT1 for_stmt1 | INDENT1 while_stmt1

block2: NEWLINE block2_line+
block2_line: INDENT2 simple_stmt NEWLINE | INDENT2 if_stmt2 | INDENT2 for_stmt2 | INDENT2 while_stmt2

block3: NEWLINE block3_line+
block3_line: INDENT3 simple_stmt NEWLINE | INDENT3 if_stmt3 | INDENT3 for_stmt3 | INDENT3 while_stmt3

block4: NEWLINE block4_line+
block4_line: INDENT4 simple_stmt NEWLINE | INDENT4 if_stmt4 | INDENT4 for_stmt4 | INDENT4 while_stmt4

block5: NEWLINE block5_line+
block5_line: INDENT5 simple_stmt NEWLINE | INDENT5 if_stmt5 | INDENT5 for_stmt5 | INDENT5 while_stmt5

block6: NEWLINE block6_line+
block6_line: INDENT6 simple_stmt NEWLINE | INDENT6 if_stmt6 | INDENT6 for_stmt6 | INDENT6 while_stmt6

block7: NEWLINE block7_line+
block7_line: INDENT7 simple_stmt NEWLINE | INDENT7 if_stmt7 | INDENT7 for_stmt7 | INDENT7 while_stmt7

block8: NEWLINE block8_line+
block8_line: INDENT8 simple_stmt NEWLINE | INDENT8 if_stmt8 | INDENT8 for_stmt8 | INDENT8 while_stmt8

block9: NEWLINE block9_line+
block9_line: INDENT9 simple_stmt NEWLINE | INDENT9 if_stmt9 | INDENT9 for_stmt9 | INDENT9 while_stmt9

block10: NEWLINE block10_line+
block10_line: INDENT10 simple_stmt NEWLINE | INDENT10 if_stmt10 | INDENT10 for_stmt10 | INDENT10 while_stmt10

# 最深层不再继续嵌套（仍允许出现 if/for/while 语句头，但它们的 body 也只能在 block10 内继续写）
if_stmt10: "if" WS expr COLON block10 ("elif" WS expr COLON block10)* ("else" COLON block10)?
for_stmt10: "for" WS target WS "in" WS expr COLON block10 ("else" COLON block10)?
while_stmt10: "while" WS expr COLON block10 ("else" COLON block10)?

# 1-9 层：进入下一层
if_stmt1: "if" WS expr COLON block2 ("elif" WS expr COLON block2)* ("else" COLON block2)?
for_stmt1: "for" WS target WS "in" WS expr COLON block2 ("else" COLON block2)?
while_stmt1: "while" WS expr COLON block2 ("else" COLON block2)?

if_stmt2: "if" WS expr COLON block3 ("elif" WS expr COLON block3)* ("else" COLON block3)?
for_stmt2: "for" WS target WS "in" WS expr COLON block3 ("else" COLON block3)?
while_stmt2: "while" WS expr COLON block3 ("else" COLON block3)?

if_stmt3: "if" WS expr COLON block4 ("elif" WS expr COLON block4)* ("else" COLON block4)?
for_stmt3: "for" WS target WS "in" WS expr COLON block4 ("else" COLON block4)?
while_stmt3: "while" WS expr COLON block4 ("else" COLON block4)?

if_stmt4: "if" WS expr COLON block5 ("elif" WS expr COLON block5)* ("else" COLON block5)?
for_stmt4: "for" WS target WS "in" WS expr COLON block5 ("else" COLON block5)?
while_stmt4: "while" WS expr COLON block5 ("else" COLON block5)?

if_stmt5: "if" WS expr COLON block6 ("elif" WS expr COLON block6)* ("else" COLON block6)?
for_stmt5: "for" WS target WS "in" WS expr COLON block6 ("else" COLON block6)?
while_stmt5: "while" WS expr COLON block6 ("else" COLON block6)?

if_stmt6: "if" WS expr COLON block7 ("elif" WS expr COLON block7)* ("else" COLON block7)?
for_stmt6: "for" WS target WS "in" WS expr COLON block7 ("else" COLON block7)?
while_stmt6: "while" WS expr COLON block7 ("else" COLON block7)?

if_stmt7: "if" WS expr COLON block8 ("elif" WS expr COLON block8)* ("else" COLON block8)?
for_stmt7: "for" WS target WS "in" WS expr COLON block8 ("else" COLON block8)?
while_stmt7: "while" WS expr COLON block8 ("else" COLON block8)?

if_stmt8: "if" WS expr COLON block9 ("elif" WS expr COLON block9)* ("else" COLON block9)?
for_stmt8: "for" WS target WS "in" WS expr COLON block9 ("else" COLON block9)?
while_stmt8: "while" WS expr COLON block9 ("else" COLON block9)?

if_stmt9: "if" WS expr COLON block10 ("elif" WS expr COLON block10)* ("else" COLON block10)?
for_stmt9: "for" WS target WS "in" WS expr COLON block10 ("else" COLON block10)?
while_stmt9: "while" WS expr COLON block10 ("else" COLON block10)?

# ---------------- statements ----------------

simple_stmt: assign_stmt
           | return_stmt
           | expr_stmt
           | pass_stmt
           | break_stmt
           | continue_stmt

pass_stmt: "pass"
break_stmt: "break"
continue_stmt: "continue"

assign_stmt: target WS? ASSIGN WS? expr

target: NAME
      | atom DOT NAME
      | atom LBRACK expr RBRACK

return_stmt: "return" (WS expr)?

expr_stmt: expr

# ---------------- expressions ----------------

expr: or_test

or_test: and_test (WS "or" WS and_test)*
and_test: not_test (WS "and" WS not_test)*
not_test: "not" WS not_test
        | comparison

comparison: arith_expr (WS? comp_op WS? arith_expr)*

comp_op: LT | GT | EQUALS | GT_EQ | LT_EQ | NOT_EQ
       | "in"
       | "not" WS "in"
       | "is"
       | "is" WS "not"

arith_expr: term (WS? (ADD | MINUS) WS? term)*
term: factor (WS? (STAR | DIV | MOD | IDIV) WS? factor)*

factor: (ADD | MINUS | NOT_OP) WS? factor
      | power

power: atom_expr (WS? POWER WS? factor)?

atom_expr: atom trailer*

trailer: LPAREN arg_list? RPAREN
       | DOT NAME
       | LBRACK expr RBRACK

arg_list: expr (COMMA WS? expr)*

atom: NAME
    | NUMBER
    | STRING
    | "None"
    | "True"
    | "False"
    | LPAREN WS? expr WS? RPAREN
    | LBRACK list_items? RBRACK
    | LBRACE dict_items? RBRACE

list_items: expr (COMMA WS? expr)* (COMMA)?

dict_items: dict_item (COMMA WS? dict_item)* (COMMA)?
dict_item: expr WS? COLON WS? expr

# ---------------- terminals ----------------
NEWLINE: "\n"
WS: " "
COMMA: ","
DOT: "."
COLON: ":"
LPAREN: "("
RPAREN: ")"
LBRACK: "["
RBRACK: "]"
LBRACE: "{"
RBRACE: "}"

ASSIGN: "="
ARROW: "->"

ADD: "+"
MINUS: "-"
STAR: "*"
DIV: "/"
MOD: "%"
IDIV: "//"
POWER: "**"
NOT_OP: "~"

LT: "<"
GT: ">"
EQUALS: "=="
GT_EQ: ">="
LT_EQ: "<="
NOT_EQ: "!="

INDENT1: "    "
INDENT2: "        "
INDENT3: "            "
INDENT4: "                "
INDENT5: "                    "
INDENT6: "                        "
INDENT7: "                            "
INDENT8: "                                "
INDENT9: "                                    "
INDENT10: "                                        "

NAME: /[A-Za-z_][A-Za-z0-9_]*/
NUMBER: /[0-9]+(\.[0-9]+)?/
STRING: /"([^"\\]|\\.)*"/

type_name: NAME (DOT NAME)*
