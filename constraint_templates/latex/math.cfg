start: s


s: expr

# 比较（允许链式比较）
expr: sum (WS? COMP_OP WS? sum)*

# 加减
sum: prod (WS? (PLUS|MINUS) WS? prod)*

# 乘除：显式 * / \cdot \times \div
prod: pow (WS? (STAR|SLASH|CDOT|TIMES|DIVCMD) WS? pow)*

# 幂：右结合
pow: postfix (WS? CIRCUMFLEX WS? group)*

# 后缀：阶乘
postfix: unary (WS? BANG)*

# 一元正负
unary: (PLUS|MINUS) WS? unary | atom

# 原子：base + (可选 sub) + (可选 sup)
atom: base sub? sup?
sub: WS? UNDERSCORE WS? group
sup: WS? CIRCUMFLEX WS? group

# group：括号包裹 expr，或一个 base
group: LBRACE WS? expr WS? RBRACE
     | LPAR WS? expr WS? RPAR
     | LBRACK WS? expr WS? RBRACK
     | base

# base：核心构件（注意把括号表达式也允许成 base，从而支持以 '(' 开头）
base: NUMBER
    | IDENT
    | const
    | greek
    | frac
    | sqrt
    | func_call
    | paren_expr

paren_expr: LPAR WS? expr WS? RPAR

# \frac{a}{b}
frac: BSLASH "frac" WS? LBRACE WS? expr WS? RBRACE WS? LBRACE WS? expr WS? RBRACE

# \sqrt[n]{x} 或 \sqrt{x}
sqrt: BSLASH "sqrt" WS? sqrt_opt WS? LBRACE WS? expr WS? RBRACE
sqrt_opt: LBRACK WS? expr WS? RBRACK
        | 

# \sin x / \sin(x) 等
func_call: func WS? func_arg
func: BSLASH FUNC_NAME
func_arg: group | base

# 希腊字母：\alpha ...
greek: BSLASH GREEK_NAME

# 常量
const: "i" | "e" | BSLASH "pi"

# ---------------- terminals ----------------

PLUS: "+"
MINUS: "-"
STAR: "*"
SLASH: "/"
CIRCUMFLEX: "^"
UNDERSCORE: "_"
BANG: "!"
EQUAL: "="

LPAR: "("
RPAR: ")"
LBRACK: "["
RBRACK: "]"
LBRACE: "{"
RBRACE: "}"

BSLASH: "\\"

# 乘除命令
CDOT: BSLASH "cdot"
TIMES: BSLASH "times"
DIVCMD: BSLASH "div"

# 比较（至少覆盖 \geq）
COMP_OP: GEQ | LEQ | LT | GT | EQUAL
GEQ: BSLASH "geq"
LEQ: BSLASH "leq"
LT: "<"
GT: ">"

# 空格（1+）
WS: /[ ]+/

# 数字/标识符：单 token，降低切分歧义
NUMBER: /[0-9]+(\.[0-9]+)?/
IDENT: /[A-Za-z][A-Za-z0-9]*/

FUNC_NAME: /(sin|cos|tan|cot|sec|csc|log|ln|exp)/
GREEK_NAME: /(alpha|beta|gamma|delta|epsilon|zeta|eta|theta|iota|kappa|lambda|mu|nu|xi|omicron|pi|rho|sigma|tau|upsilon|phi|chi|psi|omega)/
